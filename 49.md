
NIP-49
======

Encrypted Private Key
---------------------

`draft` `optional` `author:mikedilger`

This NIP defines a method by which clients can export and/or import a password-encrypted private key for the purposes of transport or storage. Such functionality SHOULD be offered to users in preference to exporting their private key in a raw unencrypted form.

Symmetric Encryption Key derivation
-----------------------------------

Apply PBKDF2 with HMAC-SHA-256 on the password as bytes, with an empty salt, run for 2^N cycles, where the user chooses the value of N. The output is the symmetric encryption key.

N SHOULD be at least 16 (representing 65,536 iterations).  Larger values of N make password guessing more difficult, but take longer to compute.

This symmetric encryption key is temporary and should be zeroed and discarded after use and not stored or reused for any other purpose.

Encrypting/Decrypting a private key
-----------------------------------

The private key encryption process is as follows:

 - Generate a symmetric key using the previous section, and a value for N chosen by the user.
 - Apply XChaCha20-Poly1305 with the following input parameters:
     - The plaintext input is the 32 bytes of the nostr private key (not the hex or bech32 encoded string, but the full raw bytes)
     - A 96-bit nonce, randomly generated and never reused. It is critical that the nonce is fresh and random.
     - The 256-bit symmetric encryption key generated according to the previous section.
     - The following associated data:
         - One byte representing key handling security as follows:
             - 0x0 If the key is known to have been carelessly handled (printed, saved to disk, cut-and-pasted, etc)
             - 0x1 If the key is not known to have been carelessly handled (printed, saved to disk, cut-and-pasted, etc)
             - 0x2 If the client does not support tracking this information
 - Concatenate
     - One byte representing a version number, currently the number 0x2
     - One byte representing N, the number of iterations of PBKDF2 that were applied when deriving the symmetric encryption key
     - The output of XChaCha20-Poly1305
 - Encode the concatenation using bech32 with the prefix "ncryptsec"

The private key decryption process is the reverse of the encryption process:

 - Decode the bech32 string
     - Verify the bech32 prefix is "ncryptsec"
     - Decode using bech32. We call the result the concatenation.
 - Split the concatenation
     - Check the first byte for version number. It should be 2. If it is smaller and you wish to support prior algorithms,
       look into the history of this NIP for that algorithm.
     - Use the second byte as the value for N, along with the user supplied password, to generate the symmetric encryption key.
     - Subsequent bytes are called the ciphertext.
 - Decrypt the ciphertext with XChaCha20-Poly1305 using that symmetric encryption key.
 - The result will be the private key. The associated data result will be the byte indicating key handling security.

Keeping key material secure
---------------------------

It is strongly recommended that software that engages in this process zeroes the memory used by private keys and passwords before freeing it to the operating system.

Posting the encrypted private key to a relay
--------------------------------------------

To share the key with yourself at another client, the encrypted private key can be posted as the content of a nostr event using the event kind of 10002.

Even though these private keys are encrypted, it is more secure to transfer them via private means rather than over the nostr network.

Test Data
---------

The following encrypted private key:

TBD...

When decrypted with the password 'nostr' yields the following hex-encoded private key:

`a28129ab0b70c8d5e75aaf510ec00bff47fde7ca4ab9e3d9315c77edc86f037f`

The reverse process is non-deterministic due to the random nonce.

Discussion
----------

This NIP serves a very similar purpose as PKCS #8 and BIP-38 do. Those documents are referenced at the end.

## On Key Derivation

Passwords make poor cryptographic keys. Prior to use as a cryptographic key, two things need to happen:

1. An encryption key needs to be deterministically created from the password such that is has a uniform functionally random distribution of bits, such that the symmetric encryption algorithm's assumptions are valid, and
2. A slow irreversible algorithm should be injected into the process, so that brute-force attempts to decrypt by trying many passwords are severely hampered.

PBKDF2 with HMAC-SHA-256 serves this purpose.

Note that this algorithm was originally designed for hashing passwords, and as such includes a random salt such that rainbow tables cannot be generated. However, this adds nothing in our case. We have no risk of exposing hashing passwords which can be looked up in a rainbow table. The 'hash' is being used as an encryption key of a 256-bit secret functionally random value and then discarded and zeroed. And the key being encrypted provides 256 bits of functional randomness that already salts the output far more than a PBKDF2 salt would.

## On the symmetric encryption algorithm

XChaCha20-Poly1305 is typically favored by cryptographers over AES and is less associated with the U.S. government.  It (or it's earlier variant without the 'X') is gaining wide usage, is used in TLS and OpenSSH, and is available in most modern crypto libraries.

Motivation
----------

There will always be a wide selection of clients. Users should be able to move/share their identity between them without risking exposing their private key. Short of the use of hardware security token support, some encryption algorithm such as the one in this NIP is warranted.

Today, when users of nostr wish to switch to another client, or use multiple clients, they export their private key in bech32 'nsec' format, which is not encrypted in any way. Any leakage of such an exported key compromises their security. And yet people typically cut-and-paste such keys and/or store them in a file on their computer.

References
----------

[PKCS #8, RFC 5208](https://datatracker.ietf.org/doc/html/rfc5208)
[BIP-38](https://github.com/bitcoin/bips/blob/master/bip-0038.mediawiki)
